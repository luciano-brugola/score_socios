---
title: ""
output: 
  html_document:
     toc: yes
     code_folding: hide
     toc_float: yes
     df_print: paged
     theme: united
     code_download: true
     includes:
       before_body: logo.html
     warning: FALSE
date: "`r format(Sys.time(), '%d-%m-%Y')`"
knit: (function(inputFile, encoding) {
    rmarkdown::render(
        inputFile, encoding = encoding,
        output_file = file.path(
            dirname(inputFile), paste0('EDA_Score_socios_preex_',Sys.Date(),'.html')))
    })
---

<h1 style="color:#0066B3; text-align:left; margin-top: 20px;">Score Socios con Preexistencias</h1>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,warning = FALSE,message = FALSE)
```


```{r,echo=FALSE}
#Carga de Librerias y funciones

library(odbc)
library(DBI)
library(tidyverse)  # para dplyr
library(lubridate)
library(stringr)
library(readr)
library(ggplot2)
library(plotly)
library(openxlsx)
library(readxl)
library(tictoc)
library(gridExtra)
library(writexl)
library(kableExtra)
library(stringr)
library(corrplot)
library(tictoc)
library(RODBC)
library(zoo)
library(scales)


```

```{r,echo=FALSE}

#Funcion para establecer la conexión a SQL Server
conectar_sql <- function(dsn, database, uid, pwd, timeout = 10) {
  con <- dbConnect(odbc::odbc(),
                   dsn,
                   database = database,
                   uid = uid,
                   pwd = pwd,
                   timeout = timeout)
  return(con)}

# Levantamos la funcion con encoding
funserver <- Sys.getenv("RFUN_PATH")
source(paste0(funserver,"/sqlQueryIn.R"))
source(paste0(funserver,"/my_sqlQuery_encoding.R"))

```


```{r}

# Levantamos la informacion correspondiente a la base de titulares
query_text1 <- paste0("SELECT [DNUM_ID_SOLICITUD]
      ,FC.DNUM_FECHA AS FECHA_CREACION
      ,FA.DNUM_FECHA AS FECHA_APROBACION
      ,FAC.DNUM_FECHA AS FECHA_ACTUALIZACION
      ,FV.DNUM_FECHA AS FECHA_VIGENCIA
      ,[DDES_TIPO_AFILIADO]
      ,[DDES_TIPO_SOLICITUD]
      ,[DCOD_MODO_CONTRATACION]
      ,[DDES_ESTADO]
      ,[DCOD_PLAN_ALTA_f1]
      ,[APELLIDO_NOMBRE]
      ,[DCOD_TIPO_DOCUMENTO]
      ,[DNUM_DOCUMENTO]
      ,[EDAD]
      ,[Composición Familiar] as Composicion_Familiar
      ,[DNUM_CUIT_EMPRESA]
      ,[TITULAR]
      ,[GF_ORDEN]
      ,[¿Cuál es tu sexo?] as Pregunta_1
      ,[¿Estás embarazada?] as Pregunta_2
      ,[¿Cuál es la fecha de tu última menstruación?] as Pregunta_3
      ,[¿Te realizaste análisis en el último año?] as Pregunta_4
      ,[¿Los resultados fueron normales?] as Pregunta_5
      ,[¿Cuál fue el diagnóstico?] as Pregunta_6
      ,[Altura]
      ,[Peso]
      ,[¿Tenés o tuviste algún tipo de adicción a las drogas y/o al alcohol?] as Pregunta_7
      ,[¿Qué patología de visión presenta?] as Pregunta_8
      ,[¿Tenés o tuviste alguna de las siguientes patologías?] as Pregunta_9
      ,[¿Qué patología de audición presenta?] as Pregunta_10
      ,[¿Qué patología hereditaria presenta?] as Pregunta_11
      ,[Alguna patologia que no este en el listado de visión] as Pregunta_12
      ,[¿Qué patología psiquiátrica presenta?] as Pregunta_13
      ,[Graduación de miopía] as Pregunta_14
      ,[¿Te realizaron cirugías?] as Pregunta_15
      ,[¿Cuál fue la intervención Sistema nervioso? y ¿Cuál fue su diagnóstico?] as Pregunta_16
      ,[¿Cuál fue el año de la intervención del Sistema Nervioso?] as Pregunta_17
      ,[¿Cuál fue la intervención Abdominal? y ¿Cuál fue su diagnóstico?] as Pregunta_18
      ,[¿Cuál fue el año de la intervención Abdominal?] as Pregunta_19
      ,[¿Cuál fue la intervención Sistema endocrino? y ¿Cuál fue su diagnóstico?] as Pregunta_20
      ,[¿Cuál fue el año de la intervención Sistema endocrino?] as Pregunta_21
      ,[¿Cuál fue la intervención Cardiológica? y ¿Cuál fue su diagnóstico?] as Pregunta_22
      ,[¿Cuál fue el año de la intervención Cardiológica?] as Pregunta_23
      ,[¿Cuál fue la intervención Ginecológica? y ¿Cuál fue su diagnóstico?] as Pregunta_24
      ,[¿Cuál fue el año de la intervención Ginecológica?] as Pregunta_25
      ,[¿Cuál fue la intervención Traumatológica? y ¿Cuál fue su diagnóstico?] as Pregunta_26
      ,[¿Cuál fue el año de la intervención Traumatológica?] as Pregunta_27
      ,[¿Tiene protesis?] as Pregunta_28
      ,[¿Cuál fue la intervención Otras? y ¿Cuál fue su diagnóstico?] as Pregunta_29
      ,[¿Cuál fue el año de la intervención Otras?] as Pregunta_30
      ,[¿Que cirugía del listado?] as Pregunta_31
      ,[¿Tuviste, tenés o estás tramitando algún certificado de discapacidad?] as Pregunta_32
      ,[Fecha baja certificado discapacidad] as Fecha_Baja_Cert_Disca
      ,[Diagnóstico discapacidad] as Diag_Disca
      ,[Fecha alta certificado discapacidad] as Fecha_Alta_Cert_Disca
      ,[¿Te encontrás realizando alguno de los siguientes tratamientos?] as Pregunta_33
      ,[¿Tenés planeado realizar algún tratamiento, práctica o intervención durante los próximos 6 meses?] as Pregunta_34
      ,[¿Que tratamiento tienes pensado hacer?] as Pregunta_35
      ,[DDJJ_Completa]
      ,[¿Tienes alguna patología?] as Pregunta_36
      ,[¿Padecés alguna/s patología/s además de las mencionadas anteriormente?] as Pregunta_37
      ,[¿Tuviste internaciones?] as Pregunta_38
      ,[Cuantas internaciones tuvo] as Pregunta_39
      ,[Motivo de la internación] as Pregunta_40
      ,[¿Cuál fue el año de la internación?] as Pregunta_41
      ,[VALIDAR]
      ,[IMC] 
      FROM [DBPresupuestos].[dbo].[DWALTAS_ONLINE_DDJJ_TITULAR_v2] A
      LEFT JOIN [DWDATAMART].[dbo].[DFECHA] FC ON FC.DID_FECHA = A.DID_FECHA_CREACION
      LEFT JOIN [DWDATAMART].[dbo].[DFECHA] FA ON FA.DID_FECHA = A.DID_FECHA_APROBACION
      LEFT JOIN [DWDATAMART].[dbo].[DFECHA] FV ON FV.DID_FECHA = A.DID_FECHA_VIGENCIA
      LEFT JOIN [DWDATAMART].[dbo].[DFECHA] FAC ON FAC.DID_FECHA = A.DID_FECHA_ACTUALIZACION")

query_text2 <- paste0("SELECT [DNUM_ID_SOLICITUD]
      ,FC.DNUM_FECHA AS FECHA_CREACION
      ,FA.DNUM_FECHA AS FECHA_APROBACION
      ,FAC.DNUM_FECHA AS FECHA_ACTUALIZACION
      ,FV.DNUM_FECHA AS FECHA_VIGENCIA
      ,[DDES_TIPO_AFILIADO]
      ,[DDES_TIPO_SOLICITUD]
      ,[DCOD_MODO_CONTRATACION]
      ,[DDES_ESTADO]
      ,[APELLIDO_NOMBRE]
      ,[DCOD_TIPO_DOCUMENTO]
      ,[DNUM_DOCUMENTO]
      ,[EDAD]
      ,[TITULAR]
      ,[GF_ORDEN]
      ,[¿Cuál es tu sexo?] as Pregunta_1
      ,[¿Estás embarazada?] as Pregunta_2
      ,[¿Cuál es la fecha de tu última menstruación?] as Pregunta_3
      ,[¿Te realizaste análisis en el último año?] as Pregunta_4
      ,[¿Los resultados fueron normales?] as Pregunta_5
      ,[¿Cuál fue el diagnóstico?] as Pregunta_6
      ,[Altura]
      ,[Peso]
      ,[¿Tenés o tuviste algún tipo de adicción a las drogas y/o al alcohol?] as Pregunta_7
      ,[¿Qué patología de visión presenta?] as Pregunta_8
      ,[¿Tenés o tuviste alguna de las siguientes patologías?] as Pregunta_9
      ,[¿Qué patología de audición presenta?] as Pregunta_10
      ,[¿Qué patología hereditaria presenta?] as Pregunta_11
      ,[Alguna patologia que no este en el listado de visión] as Pregunta_12
      ,[¿Qué patología psiquiátrica presenta?] as Pregunta_13
      ,[Graduación de miopía] as Pregunta_14
      ,[¿Te realizaron cirugías?] as Pregunta_15
      ,[¿Cuál fue la intervención Sistema nervioso? y ¿Cuál fue su diagnóstico?] as Pregunta_16
      ,[¿Cuál fue el año de la intervención del Sistema Nervioso?] as Pregunta_17
      ,[¿Cuál fue la intervención Abdominal? y ¿Cuál fue su diagnóstico?] as Pregunta_18
      ,[¿Cuál fue el año de la intervención Abdominal?] as Pregunta_19
      ,[¿Cuál fue la intervención Sistema endocrino? y ¿Cuál fue su diagnóstico?] as Pregunta_20
      ,[¿Cuál fue el año de la intervención Sistema endocrino?] as Pregunta_21
      ,[¿Cuál fue la intervención Cardiológica? y ¿Cuál fue su diagnóstico?] as Pregunta_22
      ,[¿Cuál fue el año de la intervención Cardiológica?] as Pregunta_23
      ,[¿Cuál fue la intervención Ginecológica? y ¿Cuál fue su diagnóstico?] as Pregunta_24
      ,[¿Cuál fue el año de la intervención Ginecológica?] as Pregunta_25
      ,[¿Cuál fue la intervención Traumatológica? y ¿Cuál fue su diagnóstico?] as Pregunta_26
      ,[¿Cuál fue el año de la intervención Traumatológica?] as Pregunta_27
      ,[¿Tiene protesis?] as Pregunta_28
      ,[¿Cuál fue la intervención Otras? y ¿Cuál fue su diagnóstico?] as Pregunta_29
      ,[¿Cuál fue el año de la intervención Otras?] as Pregunta_30
      ,[¿Que cirugía del listado?] as Pregunta_31
      ,[¿Tuviste, tenés o estás tramitando algún certificado de discapacidad?] as Pregunta_32
      ,[Fecha baja certificado discapacidad] as Fecha_Baja_Cert_Disca
      ,[Diagnóstico discapacidad] as Diag_Disca
      ,[Fecha alta certificado discapacidad] as Fecha_Alta_Cert_Disca
      ,[¿Te encontrás realizando alguno de los siguientes tratamientos?] as Pregunta_33
      ,[¿Tenés planeado realizar algún tratamiento, práctica o intervención durante los próximos 6 meses?] as Pregunta_34
      ,[¿Que tratamiento tienes pensado hacer?] as Pregunta_35
      ,[DDJJ_Completa]
      ,[¿Tienes alguna patología?] as Pregunta_36
      ,[¿Padecés alguna/s patología/s además de las mencionadas anteriormente?] as Pregunta_37
      ,[¿Tuviste internaciones?] as Pregunta_38
      ,[Cuantas internaciones tuvo] as Pregunta_39
      ,[Motivo de la internación] as Pregunta_40
      ,[¿Cuál fue el año de la internación?] as Pregunta_41
      ,[VALIDAR]
      ,[IMC] 
      FROM [DBPresupuestos].[dbo].[DWALTAS_ONLINE_DDJJ_GF_v2] A
      LEFT JOIN [DWDATAMART].[dbo].[DFECHA] FC ON FC.DID_FECHA = A.DID_FECHA_CREACION
      LEFT JOIN [DWDATAMART].[dbo].[DFECHA] FA ON FA.DID_FECHA = A.DID_FECHA_APROBACION
      LEFT JOIN [DWDATAMART].[dbo].[DFECHA] FV ON FV.DID_FECHA = A.DID_FECHA_VIGENCIA
      LEFT JOIN [DWDATAMART].[dbo].[DFECHA] FAC ON FAC.DID_FECHA = A.DID_FECHA_ACTUALIZACION")


# Levantamos el de titulares
#tic()
#df_original <- my_sqlQuery_encoding(2,query_text1)
#save(df_original, file = "J:/67_Preexistencia/df_original.RData")
load("df_original.RData")
#toc()

# Levantamos el de grupo familiar
#tic()
#data_gf <- my_sqlQuery_encoding(2,query_text2)
#save(data_gf, file = "J:/67_Preexistencia/data_gf.RData")
# load("data_gf.RData")
#toc()



# Reemplazamos todas las cadenas vacias por NA en Titulares
df_original[df_original == ""] <- NA
# Reemplazamos todas las cadenas vacias por NA en Grupo Familiar
# data_gf[data_gf == ""] <- NA


# Sacamos los puntos de la columna
df_original$DNUM_DOCUMENTO <- gsub("\\.", "", df_original$DNUM_DOCUMENTO)

# Vamos a limpiar los DNI
df_original$DNUM_DOCUMENTO2 = as.character(as.numeric(df_original$DNUM_DOCUMENTO))

# Ifelse para completar
df_original$DNUM_DOCUMENTO = ifelse(is.na(df_original$DNUM_DOCUMENTO2), df_original$DNUM_DOCUMENTO, df_original$DNUM_DOCUMENTO2)

# Eliminamos los valores vacios antes y despues
df_original$DNUM_DOCUMENTO = trimws(df_original$DNUM_DOCUMENTO)

# Eliminamos el campo
df_original$DNUM_DOCUMENTO2 = NULL


```


Se nos proporcionaron dos bases de datos correspondientes al formulario F1: una relativa a los titulares y otra al grupo familiar. El presente informe se centrará exclusivamente en el análisis de los titulares, reservando para una instancia posterior el estudio conjunto de ambas bases.
`r paste0("La mínima fecha de creación  de los formularios corresponde a ", format(as.Date(as.character(min(df_original$FECHA_CREACION)), format = "%Y%m%d"), "%Y/%m/%d"), ".")`



<h1 style="color:#0066B3;">Lectura de datos</h1>

Redefinición de nombres de columnas:

- Pregunta_1: ¿Cuál es tu sexo? 
- Pregunta_2: ¿Estás embarazada?
- Pregunta_3: ¿Cuál es la fecha de tu última menstruación?
- Pregunta_4: ¿Te realizaste análisis en el último año?
- Pregunta_5: ¿Los resultados fueron normales? 
- Pregunta_6: ¿Cuál fue el diagnóstico? 
- Pregunta_7: ¿Tenés o tuviste algún tipo de adicción a las drogas y/o al alcohol?
- Pregunta_8: ¿Qué patología de visión presenta?
- Pregunta_9: ¿Tenés o tuviste alguna de las siguientes patologías?
- Pregunta_10: ¿Qué patología de audición presenta?
- Pregunta_11: ¿Qué patología hereditaria presenta?
- Pregunta_12: Alguna patologia que no este en el listado de visión
- Pregunta_13: ¿Qué patología psiquiátrica presenta?
- Pregunta_14: Graduación de miopía
- Pregunta_15: ¿Te realizaron cirugías?
- Pregunta_16: ¿Cuál fue la intervención Sistema nervioso? y ¿Cuál fue su diagnóstico?
- Pregunta_17: ¿Cuál fue el año de la intervención del Sistema Nervioso?
- Pregunta_18: ¿Cuál fue la intervención Abdominal? y ¿Cuál fue su diagnóstico?
- Pregunta_19: ¿Cuál fue el año de la intervención Abdominal?
- Pregunta_20: ¿Cuál fue la intervención Sistema endocrino? y ¿Cuál fue su diagnóstico?
- Pregunta_21: ¿Cuál fue el año de la intervención Sistema endocrino?
- Pregunta_22: ¿Cuál fue la intervención Cardiológica? y ¿Cuál fue su diagnóstico?
- Pregunta_23: ¿Cuál fue el año de la intervención Cardiológica?
- Pregunta_24: ¿Cuál fue la intervención Ginecológica? y ¿Cuál fue su diagnóstico?
- Pregunta_25: ¿Cuál fue el año de la intervención Ginecológica?
- Pregunta_26: ¿Cuál fue la intervención Traumatológica? y ¿Cuál fue su diagnóstico?
- Pregunta_27: ¿Cuál fue el año de la intervención Traumatológica?
- Pregunta_28: ¿Tiene protesis?
- Pregunta_29: ¿Cuál fue la intervención Otras? y ¿Cuál fue su diagnóstico?
- Pregunta_30: ¿Cuál fue el año de la intervención Otras?
- Pregunta_31: ¿Que cirugía del listado?
- Pregunta_32: ¿Tuviste, tenés o estás tramitando algún certificado de discapacidad?
- Pregunta_32_Fecha_Baja: Fecha baja certificado discapacidad
- Pregunta_32_Diagnostico: Diagnóstico discapacidad
- Pregunta_32_Fecha_Alta: Fecha alta certificado discapacidad 
- Pregunta_33: ¿Te encontrás realizando alguno de los siguientes tratamientos?
- Pregunta_34: ¿Tenés planeado realizar algún tratamiento, práctica o intervención durante los próximos 6 meses?
- Pregunta_35: ¿Que tratamiento tienes pensado hacer?
- Pregunta_35_DDJJ: DDJJ_Completa
- Pregunta_36: ¿Tienes alguna patología?
- Pregunta_37: ¿Padecés alguna/s patología/s además de las mencionadas anteriormente?
- Pregunta_38: ¿Tuviste internaciones?
- Pregunta_39: Cuantas internaciones tuvo
- Pregunta_40: Motivo de la internación 
- Pregunta_41: ¿Cuál fue el año de la internación? 



<h1 style="color:#0066B3;">Titulares</h1>
## Cantidad de nulos en Id Solicitud y DNI 

Dentro del presente análisis nos concentraremos principalmente en dos variables el N° de Solicitud y el N° de Documento, como se puede apreciar hay registros sin N° de Documento por lo tanto procedemos a eliminarlos:

```{r}
# Visualizacion de numero de nulos, podria ser en una tabla y los sacamos

# Hay nulos en DOCUMENTO
NULOSDNI = df_original[is.na(df_original$DNUM_DOCUMENTO),] %>% nrow()
# Hay nulos en ID_SOLICITUD
NULOSID = df_original[is.na(df_original$DNUM_ID_SOLICITUD),] %>% nrow()



# Crear dataframe con los valores solicitados
df_nulos <- data.frame(
  Detalle = c("Variable DNI", "Variable ID Solicitud"),
  Filas = format(rep(nrow(df_original), 2), big.mark = "."),  # Separador de miles
  Nulos = format(c(NULOSDNI, NULOSID), big.mark = "."),  # Separador de miles
  Porcentaje_Nulos = paste0(round(c(NULOSDNI, NULOSID) / nrow(df_original) * 100, 2), "%") # Formato porcentaje
)

# Crear tabla en Markdown con kable
kable(df_nulos, format = "markdown", align = c("l", "r", "r", "r"), col.names = c("Detalle", "Filas", "Nulos", "% Nulos"))

# Eliminamos las filas vacias en dni
df_original = df_original[!is.na(df_original$DNUM_DOCUMENTO),] # 472559

```

Eliminamos las filas correspondientes a N° de Documento vacías.




## Campo Tipo de Solicitud

En base al relevamiento podemos continuar eliminando algunos registros según el Tipo de Solicitud:


- PRE-DDJJ: cuando ingresa como Directo y/o Monotributista no tenemos que tenerlo en cuenta

- Beneficiario: cuando se da de alta alguien en el grupo familiar, los campos de la declaración vienen vacíos como titular

```{r}

# Armamos la tabla
tabla = table(df_original$DDES_TIPO_SOLICITUD)

# Convertir tabla a data.frame
tabla_df <- as.data.frame(table(df_original$DDES_TIPO_SOLICITUD))
colnames(tabla_df) <- c("Tipo de Solicitud", "Cantidad")

# Formatear y ampliar ancho
tabla_df %>%
  mutate(Cantidad = format(Cantidad, big.mark = ".", decimal.mark = ",")) %>%
  kbl(align = c("l", "r"), col.names = c("Tipo de Solicitud", "Cantidad"), format = "html") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                full_width = TRUE,
                position = "center") %>%
  row_spec(0, background = "#0066a2", color = "white", bold = TRUE)


# Nos quedamos unicamente con las de F1+DDJJ
df_original = df_original[df_original$DDES_TIPO_SOLICITUD == "F1+DDJJ",]

```


## Análisis de lógica de la base


Tenemos duplicados por DNI y por ID SOLICITUD.

No se registran más de un DNI para un mismo ID de Solicitud, pero puede venir en dos registros.

Ejemplo: Una persona selecciona de una lista de patologías en la Pregunta_8:

- Pregunta_8: ¿Qué patología de visión presenta?

Si selecciona dos en esa pregunta el registro va a venir duplicado, todos los campos idénticos excepto Pregunta_8.
Ergo, dependiendo que análisis se requiera hacer se debe tomar por patología o por persona.

Ejemplo: si se realiza un análisis de patologías debiera no tenerse en cuenta la cantidad de personas, porque una persona puede tener más de una patología. Vale la aclaración porque la cantidad de patologías puede no ser igual a la cantidad total de individuos ni siquiera con la totalidad de registros en sí. Además, no sabemos con certeza que otros campos pueden generar la apertura de registros como en el caso de la Pregunta_8. Sería ideal poder contar con el formulario porque ayudaría a la identificación de estos casos particulares.


Si se registran DNI con más de una ID de Solicitud asociada.
En principio sería correcto, ya que esto puede responder a, entre otras cosas, que la DDJJ tiene una validez de 48 horas, que se generaron diferentes solicitudes en diferentes períodos de tiempo etc.
Además, tenemos casos con DNI erróneos como 111111.




## Integridad del campo N° Solicitud y N° Documento

```{r, echo=FALSE, results='asis'}

# Vemos que haya un ID único por cada DNUM_ID_SOLICITUD
cat(paste0("<b>Cantidad de Solicitudes con más de un DNI asociado: ",
           df_original %>% 
             group_by(DNUM_ID_SOLICITUD) %>% 
             summarise(Cantidad_DNI = n_distinct(DNUM_DOCUMENTO)) %>% 
             filter(Cantidad_DNI > 1) %>% 
             nrow(),
           "</b><br>"))

# Vemos que haya una solicitud única por cada DNI 
cat(paste0("<b>Cantidad de DNI con más de una Solicitud asociada: ",
           df_original %>% 
             group_by(DNUM_DOCUMENTO) %>% 
             summarise(Cantidad_Solicitudes = n_distinct(DNUM_ID_SOLICITUD)) %>% 
             filter(Cantidad_Solicitudes > 1) %>% 
             nrow(),
           "</b><br>"))


# Hasta ahora tenemos una cantidad de filas
cat(paste0("<b>Cantidad de registros en el dataframe de titulares (una vez depurado): ",
           df_original %>% 
             nrow(),
           "</b><br>"))


# Vemos la cantidad de DNI unicos
cat(paste0("<b>Cantidad de DNI únicos en el dataframe de titulares (una vez depurado): ",
           df_original %>% 
             summarise(DNI_unicos = n_distinct(DNUM_DOCUMENTO)) %>% 
             pull(DNI_unicos),
           "</b><br>"))

```


## Integridad del formulario en sí

Realizando el análisis de la base concluímos que podríamos tomar algunos conceptos generales pero no definiciones técnicas debido a la naturaleza del dato en sí.
En el siguiente gráfico se aprecia esta hipótesis, primero identificamos todas las variables que comiencen con PREGUNTA_, luego se calcula cuántas de esas preguntas están vacías (NA) por cada fila y se transforma en un porcentaje.
Los valores sobre las barras indican la cantidad de registros en cada grupo:

```{r,eval=FALSE}
columnas_DDJJ <- names(df_original)[str_detect(string = names(df_original), pattern = "PREGUNTA_")]

df_original$Cant_Preguntas_NA <- apply(df_original[, columnas_DDJJ], 1, function(x) sum(is.na(x)))

df_original$Porcentaje_Preguntas_NA <- df_original$Cant_Preguntas_NA / length(columnas_DDJJ)

breaks <- seq(0, 1, 0.1)

# Graficamos
df_original %>% 
  ggplot(aes(x = Porcentaje_Preguntas_NA)) +
  geom_histogram(breaks = breaks, fill = "#0066a2", color = "white") +
  scale_x_continuous(breaks = breaks, labels = scales::percent_format(scale = 100)) +
  geom_text(
    stat = "bin", 
    aes(label = scales::comma(after_stat(count), big.mark = ".", decimal.mark = ",")),
    vjust = -0.25,
    breaks = breaks
  ) +
  theme_minimal() +
  labs(
    title = "Porcentaje de Preguntas incompletas",
    y = "Cantidad de Filas", 
    x = "Porcentaje de Preguntas incompletas"
  )
```

## Preexistencia

Para identificar la preexistencia vamos a tomar la PREGUNTA_9 como base:

- Pregunta_9: ¿Tenés o tuviste alguna de las siguientes patologías?

Si bien del relevamiento surge que toman además otras variables para identificar si va a cotizar o no como ser:

- Pregunta_38: ¿Tuviste internaciones?

Y otra que nos llamó la atención fue la pregunta:

- Pregunta_37: ¿Padecés alguna/s patología/s además de las mencionadas anteriormente?

La cual genera varias inconsistencias con respecto a la PREGUNTA_9.

Para tomar una definición sobre los datos que quedaron en la base, vamos a generar una visualización con los valores más frecuentes en la variable PREGUNTA_9 sin contar los valores nulos.
Los valores nulos en esa PREGUNTA_9 son de `r scales::comma(df_original %>% filter(is.na(PREGUNTA_9)) %>% nrow(), big.mark = ".", decimal.mark = ",")` registros sobre `r scales::comma(nrow(df_original), big.mark = ".", decimal.mark = ",")` registros totales.

Es importante aclarar que el gráfico refleja la cantidad de registros y no de personas ni de solicitudes, recordemos que:

- una misma solicitud puede tener múltiples registros (varias patologías) y,
- una misma persona puede haber generado más de una solicitud con diferentes respuestas


```{r}
library(dplyr)
library(plotly)


# Top 5 + Otras
top5 <- df_original %>%
  filter(!is.na(PREGUNTA_9)) %>%
  count(PREGUNTA_9, sort = TRUE) %>%
  slice_max(n, n = 5)

df_plot <- df_original %>%
  filter(!is.na(PREGUNTA_9)) %>%
  count(PREGUNTA_9) %>%
  mutate(PREGUNTA_9 = ifelse(PREGUNTA_9 %in% top5$PREGUNTA_9, PREGUNTA_9, "Otras")) %>%
  group_by(PREGUNTA_9) %>%
  summarise(n = sum(n), .groups = "drop") %>%
  mutate(
    porcentaje = n / sum(n),
    etiqueta = paste0(
      PREGUNTA_9, "<br>",
      "Cantidad: ", format(n, big.mark = ".", decimal.mark = ","), "<br>",
      "Porcentaje: ", sprintf("%.2f%%", porcentaje * 100)
    )
  ) %>%
  arrange(n)

# Gráfico de barras horizontales
plot_ly(
  data = df_plot,
  x = ~n,
  y = ~reorder(PREGUNTA_9, n),  # orden descendente
  type = "bar",
  orientation = "h",
  text = ~etiqueta,
  hoverinfo = "text",
  marker = list(color = "steelblue")
) %>%
  layout(
    title = "Top 5 respuestas en PREGUNTA_9 (sin NA)",
    xaxis = list(title = "Cantidad"),
    yaxis = list(title = ""),
    margin = list(l = 100, r = 40, b = 60, t = 50)
  )

```


## Análisis sobre Dificultades en la visión


El top de patologías se lo lleva "Dificultades en la visión", podemos aperturar esa variable si tomamos en cuenta la PREGUNTA_8:

- Pregunta_8: ¿Qué patología de visión presenta?


```{r}

library(dplyr)
library(plotly)

# 1. Filtrar los casos que respondieron "Dificultades en la visión" en PREGUNTA_9
df_vision <- df_original %>%
  filter(PREGUNTA_9 == "Dificultades en la visión")

# 2. Contar ocurrencias en PREGUNTA_8, incluyendo los NA
df_p8 <- df_vision %>%
  mutate(PREGUNTA_8 = ifelse(is.na(PREGUNTA_8), "Sin respuesta", as.character(PREGUNTA_8))) %>%
  count(PREGUNTA_8, sort = TRUE) %>%
  mutate(
    Porcentaje = n / sum(n),
    Etiqueta = paste0(PREGUNTA_8, " (", scales::percent(Porcentaje, accuracy = 0.1), ")")
  )

# 3. Crear gráfico interactivo de torta con tooltip de porcentaje
plot_ly(
  data = df_p8,
  labels = ~PREGUNTA_8,
  values = ~n,
  type = "pie",
  textinfo = "percent",
  hovertemplate = "%{label}<br>%{percent:.2%}<extra></extra>",
  marker = list(colors = RColorBrewer::brewer.pal(n = max(3, nrow(df_p8)), name = "Set3"))
) %>%
  layout(
    title = "Distribución de PREGUNTA_8 entre quienes reportaron dificultades en la visión",
    showlegend = TRUE,
    legend = list(orientation = "v", x = 1, y = 0.5)
  )

```


## Análisis sobre Miopía 

Para tomar en cuenta si el individuo tiene preexistencia con Miopía es necesario sumar el campo PREGUNTA_14:

- Pregunta_14: Graduación de miopía

La variable no presenta valores nulos y contiene únicamente dos categorías. Para el análisis próximo se considera únicamente la categoría "Igual o mayor a -6 dioptrías", que corresponderían a los registros con preexistencia:

```{r}

# Dejamos unicamente las que sean de miopia
df_vision = df_vision[df_vision$PREGUNTA_8=="Miopía",]

# Preparar los datos
df_p14 <- df_vision %>%
  mutate(PREGUNTA_14 = ifelse(is.na(PREGUNTA_14), "Sin respuesta", PREGUNTA_14)) %>%
  count(PREGUNTA_14, sort = TRUE) %>%
  mutate(
    Porcentaje = n / sum(n),
    Etiqueta = paste0(
      PREGUNTA_14, "<br>",
      "Cantidad: ", n, "<br>",
      "Porcentaje: ", scales::percent(Porcentaje, accuracy = 0.1)
    )
  )

# Gráfico interactivo
plot_ly(
  data = df_p14,
  x = ~n,
  y = ~reorder(PREGUNTA_14, n),
  type = "bar",
  orientation = "h",
  text = ~Etiqueta,
  hoverinfo = "text",
  marker = list(color = "#0066a2")
) %>%
  layout(
    title = "Distribución de respuestas en PREGUNTA_14",
    xaxis = list(title = "Cantidad"),
    yaxis = list(title = ""),
    margin = list(l = 150)
  )

# Filtramos los que tienen preexistencia (por ahora no, lo vamos a dejar)
#df_vision = df_vision[df_vision$PREGUNTA_14=="Igual o mayor a -6 dioptrías",]

```



## Análisis de consumos de los socios con y sin preexistencia en Miopía


Recapitulando el análisis tenemos un dataframe filtrado con:

- Pregunta_9: ¿Tenés o tuviste alguna de las siguientes patologías? = Dificultades en la visión
- Pregunta_8: ¿Qué patología de visión presenta?                    = Miopía


Y trabajaremos sobre la apertura del siguiente campo:

- Pregunta_14: Graduación de miopía                                 


Sobre ese dataframe, que cuenta con `r scales::comma(df_vision %>% nrow(), big.mark = ".", decimal.mark = ",")` registros, identificamos `r scales::comma(n_distinct(df_vision$DNUM_DOCUMENTO), big.mark = ".", decimal.mark = ",")` DNI únicos. A partir de esta base, analizaremos sus consumos y contribuciones marginales, teniendo en cuenta que la fecha de alta del socio debe ser posterior a la fecha de vigencia establecida en el Formulario.
Dado que necesitamos una única fecha de vigencia por socio, nos quedaremos con la última registrada, asumiendo que la existencia de múltiples solicitudes puede deberse a rechazos u omisiones previas.

Si tomamos la FECHA_VIGENCIA tenemos dos casos que en la misma última FECHA_VIGENCIA (que es coincidente entre dos registros en ambas), tienen respuestas diferentes en la PREGUNTA_14:



```{r}
# Nos vamos a quedar con la ultima fecha de creacion
# Porque si tomamos fecha vigencia tenemos para la misma persona la misma fecha de vigencia con miopia con y sin preexistencia
# Es decir en una pone mayor a menos 6 dioptrias y en la otra menor a menos 6 dioptrias

df_vision_filtrado_FV <- df_vision %>%
  group_by(DNUM_DOCUMENTO) %>%
  mutate(FECHA_VIGENCIA_ULTIMA = max(FECHA_VIGENCIA, na.rm = TRUE)) %>%
  ungroup() %>% 
  filter(FECHA_VIGENCIA_ULTIMA == FECHA_VIGENCIA)

df_vision_filtrado_FV = df_vision_filtrado_FV %>%
  group_by(DNUM_DOCUMENTO, FECHA_VIGENCIA_ULTIMA) %>%
  summarise(RTAS_DISTINTAS_PREGUNTA_14 = n_distinct(PREGUNTA_14)) %>%
  filter(RTAS_DISTINTAS_PREGUNTA_14 > 1)

df_vision_filtrado_FV %>%
  kbl(
    caption = "<b>Documentos con más de una respuesta distinta en PREGUNTA_14</b>", 
    format = "html", 
    align = "c", 
    col.names = c("DNI", "Fecha de Vigencia", "Respuestas Distintas")
  ) %>%
  kable_styling(
    full_width = TRUE,
    bootstrap_options = c("striped", "hover", "condensed"),
    position = "center"
  ) %>%
  row_spec(0, background = "#0072CE", color = "white")  # Encabezado estilo OSDE

```

## Casos particulares I

Debido a esta sitación nos vemos obligados a realizar el análisis pero en vez de por FECHA_VIGENCIA utilizaremos la FECHA_CREACION, una vez que avanzamos con esta definición nos encontramos que también el formulario apertura por la PREGUNTA_31 y por la PREGUNTA_24:

- Pregunta_31: ¿Que cirugía del listado?
- Pregunta_24: ¿Cuál fue la intervención Ginecológica? y ¿Cuál fue su diagnóstico?

```{r}
# Por lo tanto vamos a usar la FECHA CREACION
df_vision_filtrado <- df_vision %>%
  group_by(DNUM_DOCUMENTO) %>%
  mutate(FECHA_CREACION_ULTIMA = max(FECHA_CREACION, na.rm = TRUE)) %>%
  ungroup() %>% 
  filter(FECHA_CREACION_ULTIMA == FECHA_CREACION)

# Como la PREGUNTA_31 apertura tal cual a la PREGUNTA_9 vamos a hacer un distinct de los campos que vamos a utilizar ellos son

PREGUNTA_31_DF = df_vision_filtrado %>% group_by(DNUM_DOCUMENTO, FECHA_VIGENCIA, FECHA_CREACION_ULTIMA, PREGUNTA_14) %>% summarise(CANT_RESPUESTAS_PREGUNTA = n_distinct(DNUM_ID_SOLICITUD)) %>% filter(CANT_RESPUESTAS_PREGUNTA >1)




PREGUNTA_31_DF %>%
  kbl(
    caption = "<b>Solicitudes con más de una respuesta distinta en PREGUNTA_31</b>", 
    format = "html", 
    align = "c", 
    col.names = c("DNI", "Fecha de Vigencia", "Última Fecha Creación", "Pregunta 14", "Cantidad de Respuestas")
  ) %>%
  kable_styling(
    full_width = TRUE,
    bootstrap_options = c("striped", "hover", "condensed"),
    position = "center"
  ) %>%
  row_spec(0, background = "#0072CE", color = "white")  # Encabezado estilo OSDE


```

## Casos particulares II

Dado que para el análisis de consumos la variable PREGUNTA_31 y PREGUNTA_24 no resulta relevante, decidimos continuar con el análisis prescindiendo de ella. Sin embargo, nos encontramos con dos casos particulares en los que, si bien comparten la misma última FECHA_CREACION, presentan dos FECHA_VIGENCIA distintas. Como utilizaremos esta última variable para realizar el cruce con los consumos, se definió tomar, en estos casos, la última FECHA_VIGENCIA registrada, que a su vez coincide con el ID de solicitud mayor.


```{r}
# Dejamos los campos que nos interesan
df_vision_filtrado = df_vision_filtrado %>% ungroup() %>%  distinct(DNUM_DOCUMENTO, FECHA_VIGENCIA, FECHA_CREACION_ULTIMA, PREGUNTA_14) 

# Aca mostramos lo que aparece casos especiales a tener en cuenta
PROBLEMA = df_vision_filtrado %>%
  group_by(DNUM_DOCUMENTO) %>%
  filter(n() > 1)

old_locale <- Sys.getlocale(category = "LC_TIME")
invisible(x = Sys.setlocale("LC_TIME", "Spanish_Argentina.UTF-8"))
# Lo pasamos a fecha
PROBLEMA <- PROBLEMA %>% mutate(FECHA_VIGENCIA = ymd(FECHA_VIGENCIA))
PROBLEMA <- PROBLEMA %>% mutate(FECHA_CREACION_ULTIMA = ymd(FECHA_CREACION_ULTIMA))

# Lo pasamos a character por las dudas
PROBLEMA$FECHA_VIGENCIA = as.character(PROBLEMA$FECHA_VIGENCIA)
PROBLEMA$FECHA_CREACION_ULTIMA = as.character(PROBLEMA$FECHA_CREACION_ULTIMA)

# Ponemos bien en formato
PROBLEMA <- PROBLEMA %>% mutate(DNUM_DOCUMENTO = comma(as.numeric(DNUM_DOCUMENTO), big.mark = ".", decimal.mark = ","))


PROBLEMA %>%
  kbl(
    caption = "<b>DNI con una misma Fecha de Creación y dos Fechas de Vigencia</b>", 
    format = "html", 
    align = "c", 
    col.names = c("DNI", "Fecha de Vigencia", "Última Fecha Creación", "Pregunta 14")
  ) %>%
  kable_styling(
    full_width = TRUE,
    bootstrap_options = c("striped", "hover", "condensed"),
    position = "center"
  ) %>%
  row_spec(0, background = "#0072CE", color = "white")  # Encabezado estilo OSDE

# kable de la tabla y continuamos
```

## Casos particulares III

Una vez que nos quedamos con la última FECHA_VIGENCIA tenemos que obtener el DID_SOCIO correspondiente a ese N° de Documento con ese ID de Solicitud relacionado, por lo tanto al cruzar con la tabla DSOCIOS nos encontramos que para una misma Fecha de Alta (que coincide con la Fecha de Vigencia del Formulario) tenemos 13 DNI que tienen al menos 2 DID_SOCIO relacionados, los mismos se detallan a continuación y a la espera de definiciones se descartan para el análisis: 


```{r}

# REVISAR FECHA DE VIGENCIA QUE NO SEA LA DSOCIOS PORQUE TENEMOS DE 2009



# Nos quedamos con la ultima FECHA VIGENCIA
df_vision_filtrado <- df_vision_filtrado %>%
  group_by(DNUM_DOCUMENTO, FECHA_CREACION_ULTIMA, PREGUNTA_14) %>%
  mutate(FECHA_VIGENCIA_ULTIMA = max(FECHA_VIGENCIA, na.rm = TRUE)) %>%
  ungroup() %>% 
  filter(FECHA_VIGENCIA_ULTIMA == FECHA_VIGENCIA)


# Hasta aca tenemos todos los socios con miopia con mayor o menor a - seis dioptrias bien identificados
# Este va a ser nuestro universo total, ahora lo vamos a cruzar con socios para obtener el did_socios
# los que no cruzan bajo las definiciones que tomamos, son socios que no se dieron de alta y tendriamos
# El primer proxy de la tabla de esta cantidad cuantos se dieron de alta


# Para esos DNI vamos a traer el DNUM_IC
query_did_socios <- paste0("SELECT DISTINCT [DNUM_DOC]
      ,[DNUM_IC]
  FROM [DWDATAMART].[dbo].[DSOCIO]
  WHERE DNUM_DOC IN (#) AND FEC_ALTA < FEC_BAJA")

# Traemos los valores
DID_SOCIO <- sqlQueryIn(odbcConnect("datamart"), unique(df_vision_filtrado$DNUM_DOCUMENTO), query_did_socios)


# Hacemos un left_join para traer la fecha de vigencia maxima y poder identificar el DID_SOCIO correspondiente
SOCIOS = df_vision_filtrado %>% left_join(DID_SOCIO, by=c("DNUM_DOCUMENTO" = "DNUM_DOC"))
# Ojo que no duplique 
#nrow(df_vision_filtrado)
#nrow(SOCIOS)
# Esto una vez que hagas 

n_distinct(df_vision_filtrado$DNUM_DOCUMENTO)
n_distinct(SOCIOS$DNUM_DOCUMENTO)

#names(df_vision_filtrado)

library(lubridate)
# SOCIOS$FEC_ALTA <- ymd(SOCIOS$FEC_ALTA)
# SOCIOS$FEC_BAJA <- ymd(SOCIOS$FEC_BAJA)
# SOCIOS$FEC_VIGENCIA_PLAN <- ymd(SOCIOS$FEC_VIGENCIA_PLAN)
# SOCIOS$FECHA_VIGENCIA <- ymd(SOCIOS$FECHA_VIGENCIA)
# 
# 
# # Hacemos la resta
# SOCIOS$RESTA <- as.numeric(SOCIOS$FEC_ALTA - SOCIOS$FECHA_VIGENCIA)


# # Ahora vamos 
# SOCIOS = SOCIOS %>% group_by(DNUM_DOCUMENTO) %>% mutate(RESTA_MINIMA=min(RESTA), na.rm=TRUE) %>% filter(RESTA_MINIMA==RESTA | is.na(RESTA)) %>% ungroup()


# # Estos los vamos a mostrar y sacar del analisis
# AFILTRAR = SOCIOS %>%
#   group_by(DNUM_DOCUMENTO) %>%
#   filter(n() > 1) %>%
#   arrange(DNUM_DOCUMENTO) 
# 
# 
# # Filtramos para despues continuar
# SOCIOS = SOCIOS %>% filter(!DNUM_DOCUMENTO %in% unique(AFILTRAR$DNUM_DOCUMENTO))

# # Vamos a seleccionar algunas variabeles unicamente para mostrar
# AFILTRAR = AFILTRAR %>% select(DNUM_DOCUMENTO, DNUM_IC)
# 
# # Ponemos bien en formato
# AFILTRAR <- AFILTRAR %>% mutate(DNUM_DOCUMENTO = comma(as.numeric(DNUM_DOCUMENTO), big.mark = ".", decimal.mark = ","))
# 
# 
# AFILTRAR %>%
#   kbl(
#     caption = "<b>DNI con al menos dos DID_SOCIO (misma Fecha Alta y Fecha Vigencia Plan)</b>", 
#     format = "html", 
#     align = "c", 
#     col.names = c("DNI", "DID_SOCIO","Fecha Alta", "Fecha Baja", "Fecha de Vigencia")
#   ) %>%
#   kable_styling(
#     full_width = TRUE,
#     bootstrap_options = c("striped", "hover", "condensed"),
#     position = "center"
#   ) %>%
#   row_spec(0, background = "#0072CE", color = "white")  # Encabezado estilo OSDE
# #n_distinct(AFILTRAR$DNUM_DOCUMENTO)

```

## Planteo de escenarios


Definimos tomar 3 categorías posibles en la búsqueda de DNUM_IC relacionado con su ID de Solicitud:

1- 1 DNUM_IC: Se halló un único DNUM_IC.

2- 2 DNUM_IC: Se hallaron dos DNUM_IC distintos. Esto no debería ser posible. Existen 21 personas en esta situación. Se detallan más abajo.

3- 0 DNUM_IC: No se halló ningún IC. Esto significa que la persona nunca fue dada de alta como socio.

Para el análisis buscaremos los consumos de todos los DNUM_IC hallados de aquellos socios en 1-. 

```{r}

# Aca si tenemos nuestro universo total unico de personas a las que vamos a analizarle lso consumos
# La tabla de cantidad de gente deberia ser esta la base

# Armamos las variables
TOPEDIAS = 10

# Armamos las categorias
SOCIOS$CATEGORIA = ifelse(is.na(SOCIOS$DNUM_IC), "DNI sin DNUM_IC", "DNI con DNUM_IC")

SOCIOS_CANT_DNUM_IC <- SOCIOS %>% 
                          dplyr::group_by(DNUM_DOCUMENTO,PREGUNTA_14) %>% 
                          dplyr::summarise(Cantidad_DNUM_IC = paste0(n_distinct(DNUM_IC,na.rm = TRUE)," DNUM_IC"))
# Entonces grafico de barra de 3 categorias y puedo hablar de personas porque tenemos identificados ya 
# un registro por persona

# busco las personas que tienen mas de 
dni_multiple_IC <- SOCIOS_CANT_DNUM_IC %>% 
                        dplyr::filter(Cantidad_DNUM_IC == "2 DNUM_IC") %>% 
                        dplyr::pull(DNUM_DOCUMENTO) %>% 
                        unique()

df_stacked <- SOCIOS_CANT_DNUM_IC %>%
  mutate(
    CATEGORIA = Cantidad_DNUM_IC,
    PREGUNTA_14 = ifelse(is.na(PREGUNTA_14), "NA", PREGUNTA_14)
  ) %>%
  dplyr::ungroup() %>% 
  count(CATEGORIA, PREGUNTA_14)

plot_ly(df_stacked,
        x = ~CATEGORIA,
        y = ~n,
        color = ~PREGUNTA_14,
        type = "bar",
        text = ~paste0("Cantidad ICs: ", CATEGORIA,
                       "<br>Pregunta 14: ", PREGUNTA_14,
                       "<br>Cantidad: ", format(n, big.mark = ".", decimal.mark = ",")),
        hoverinfo = "text") %>%
  layout(
    barmode = "stack",
    title = "Cantidad de ICs por Socio según número de Dioptrías",
    xaxis = list(title = "Categoría"),
    yaxis = list(title = "Cantidad")
  )

SOCIOS %>%
  dplyr::filter(DNUM_DOCUMENTO %in% dni_multiple_IC) %>%
  dplyr::distinct(DNUM_DOCUMENTO,FECHA_VIGENCIA,FECHA_CREACION_ULTIMA,PREGUNTA_14,DNUM_IC) %>% 
  kbl(
    caption = "<b>DNI con dos DNUM_IC</b>",
    format = "html",
    align = "c",
    col.names = c("DNI", "Fecha de Vigencia","Fecha Creación Última", "Pregunta 14", "DNUM_IC")
  ) %>%
  kable_styling(
    full_width = TRUE,
    bootstrap_options = c("striped", "hover", "condensed"),
    position = "center"
  ) %>%
  row_spec(0, background = "#0072CE", color = "white")  # Encabezado estilo OSDE
#n_distinct(AFILTRAR$DNUM_DOCUMENTO)

```


Si queremos analizar si se encuentra el DNI en la base de Socios sin importar si se detectaron más de 1 DNUM_IC podríamos agrupar en dos categorías y visualizarlo de la siguiente manera:

```{r}

SOCIOS_CANT_DNUM_IC$Con_IC = ifelse(SOCIOS_CANT_DNUM_IC$Cantidad_DNUM_IC=="0 DNUM_IC", "Sin DNUM_IC", "Con DNUM_IC")


# Preparar los datos
df_pie <- SOCIOS %>%
  dplyr::distinct(DNUM_DOCUMENTO,CATEGORIA) %>% 
  count(CATEGORIA) %>%
  mutate(porcentaje = n / sum(n),
         etiqueta = paste0(
           CATEGORIA, "<br>",
           "Cantidad: ", format(n, big.mark = ".", decimal.mark = ","), "<br>",
           "Porcentaje: ", sprintf("%.1f%%", porcentaje * 100))
  )

# Gráfico de torta
plot_ly(
  data = df_pie,
  labels = ~CATEGORIA,
  values = ~n,
  type = "pie",
  textinfo = "percent",        # Solo porcentaje en la torta
  hoverinfo = "text",
  text = ~etiqueta,
  marker = list(line = list(color = '#FFFFFF', width = 1))
) %>%
  layout(
    title = "Distribución de Socios según DNUM_IC",
    legend = list(
      x = 1,
      y = 0.5,
      yanchor = "middle"
    ),
    margin = list(l = 40, r = 160, b = 40, t = 40),
    height = 500,
    width = 700
  )


# Una vez que mostras esa visualizacion vamos a empezar a trabajar con los DNUM_IC que encontro
# Y eso lo vamos a aperturar por la PREGUNTA_14

PARA_CONSUMO = SOCIOS %>% 
                  dplyr::left_join(y = SOCIOS_CANT_DNUM_IC %>% 
                                            dplyr::distinct(DNUM_DOCUMENTO,Cantidad_DNUM_IC)) %>% 
                  dplyr::filter(Cantidad_DNUM_IC=="1 DNUM_IC")

```


## Análisis Rango de tiempo de Consumos

Tomando únicamente los socios para los cuales hallamos algún DNUM_IC nos quedan `r scales::comma(n_distinct(PARA_CONSUMO$DNUM_DOCUMENTO), big.mark = ".", decimal.mark = ",")` personas. Cuando traemos los consumos, necesitamos definir un período de tiempo a considerar, debido a que a veces el alta del socio se realiza de forma diferida y no coincide su fecha con la fecha de vigencia.


```{r}
# Aca ya estamos trabajando con los socios que pudimos a partir de su DOCUMENTO encontrar su DID_SOCIO que tiene
# coincidente la fecha de vigencia con la fecha de alta
# Este es nuestro universo total de personas a analizar los consumos





# Podemos hablar de porcentajes primera variable seria PREGUNTA_14 que va a adoptar dos valores
# La segunda variable es cantidad de personas 
# La tercera variable seria PROMEDIO MENSUAL de CONSUMOS / MESES (agrupado por persona y por categoria PREGUNTA_14) de OFTALMOLOGIA
# La cuarta variable es % de uso de esa cirugia que vimos 
# La quinta promedio de CMG por grupo



# Histograma de consumos 



# Traemos los consumos
query_consumos_socios_preexistencias <- paste0("SELECT SO.DNUM_IC
    ,SO.DNUM_DOC
    ,SO.FEC_NACIMIENTO
	  ,CO.DID_NOMENCLADOR
	  ,CO.DID_MEDICAMENTO
	  ,NOM.DCOD_PRACTICA
	  ,NOM.DDES_PRACTICA
	  ,NOM.CAPITULO
	  ,NOM.SUBCAPITULO
	  ,GP.GRUPO
	  ,GP.GRUPO_PRESUPUESTO
	  ,DC.DDES_CLASECOSTO AS 'DDES_GRUPO_PRESUPUESTO'
	  ,ME.DCOD_MEDICAMENTO
	  ,ME.DDES_MEDICAMENTO
	  ,F.DNUM_FECHA 
    ,SUM([NUM_CANTIDAD]) AS 'FRECUENCIA'
    ,SUM([NUM_IMPORTE_TOTAL]) AS 'IMPORTE_TOTAL'
  FROM [DWDATAMART].[dbo].[vDWCONSUMOS] CO
  LEFT JOIN [DWDATAMART].[dbo].DNOMENCLADOR NOM ON NOM.DID_NOMENCLADOR = CO.DID_NOMENCLADOR
  LEFT JOIN [DWDATAMART].[dbo].DMEDICAMENTO ME ON ME.DID_MEDICAMENTO = CO.DID_MEDICAMENTO
  LEFT JOIN [DWDATAMART].[dbo].DFECHA F ON F.DID_FECHA = CO.DID_FECHA_PRESTACION
  LEFT JOIN [DWDATAMART].[dbo].DGRUPO_PRESUPUESTO GP ON GP.DID_GRUPO_PRESUPUESTO = CO.DID_GRUPO_PRESUPUESTO
  LEFT JOIN [DWDATAMART].[dbo].DCLASECOSTO DC ON DC.DID_CLASECOSTO = GP.DID_GRUPO_PRESUPUESTO
  LEFT JOIN [DWDATAMART].[dbo].DSOCIO SO ON SO.DID_SOCIO = CO.DID_SOCIO
  WHERE CO.DID_FILIALCONSUMO IN ('38') and
      SO.DNUM_IC IN (#)
		AND CO.DID_NOMENCLADOR <> -1
		AND CO.DID_TIPO_FACTURACION = 1
  GROUP BY SO.DNUM_IC
    ,SO.DNUM_DOC
    ,SO.FEC_NACIMIENTO
	  ,CO.DID_NOMENCLADOR
	  ,CO.DID_MEDICAMENTO
	  ,NOM.DCOD_PRACTICA
	  ,NOM.DDES_PRACTICA
	  ,NOM.CAPITULO
	  ,NOM.SUBCAPITULO
	  ,GP.GRUPO
	  ,GP.GRUPO_PRESUPUESTO
	  ,DC.DDES_CLASECOSTO
	  ,ME.DCOD_MEDICAMENTO
	  ,ME.DDES_MEDICAMENTO
	  ,F.DNUM_FECHA")

# Deberiamos filtrar por la fecha de vigencia

tic()
# Traemos los consumos
CONSUMOS <- sqlQueryIn(odbcConnect("datamart"), as.character(PARA_CONSUMO$DNUM_IC), query_consumos_socios_preexistencias)
toc()

load("Z:/Gcia Presupuesto/DATA MINING/procesos/cmg/data/precioshist.RData")
precios.hist$MES <- as.yearmon(precios.hist$MES)

# Pegamos la Fecha de Vigencia y la pregunta 14
CONSUMOS_SOCIOS <- CONSUMOS %>% 
                      dplyr::mutate(DNUM_IC = as.integer(DNUM_IC)) %>% 
                      dplyr::left_join(y = SOCIOS %>% dplyr::distinct(DNUM_IC,
                                                                      FECHA_VIGENCIA,
                                                                      PREGUNTA_14) %>% 
                                                      dplyr::filter(!is.na(DNUM_IC)))

# Ahora calculamos la distancia hasta la fecha de vigencia y generamos una serie de tiempo para entender donde hacer el corte de rango
CONSUMOS_SOCIOS$DIAS_HASTA_FECHA_VIGENCIA <- ymd(CONSUMOS_SOCIOS$DNUM_FECHA) - ymd(CONSUMOS_SOCIOS$FECHA_VIGENCIA)

# Sumamos los consumos por socio y luego agrupamos por cantidad de dias hasta la fecha de vigencia
# los consumos de analisis se suman contando fechas unicas, los consumos de ambulancia se cuenta 1 cada vez que el grupo es ambulancia y el resto se suma la frecuencia
CONSUMOS_SOCIOS_DIST_VIGENCIA <- CONSUMOS_SOCIOS %>% 
                                      dplyr::mutate(GRUPO_AMBUL = ifelse(GRUPO == "18 - AMBULANCIAS",1,0)) %>% 
                                      dplyr::group_by(DNUM_DOC,DIAS_HASTA_FECHA_VIGENCIA) %>% 
                                      dplyr::summarise(Frecuencia = sum(FRECUENCIA[!GRUPO %in% c("08 - ANALISIS","18 - AMBULANCIAS")]) + n_distinct(DNUM_FECHA[GRUPO == "08 - ANALISIS"]) + sum(GRUPO_AMBUL),
                                                       Importe = sum(IMPORTE_TOTAL)) %>% 
                                      dplyr::group_by(DIAS_HASTA_FECHA_VIGENCIA) %>% 
                                      dplyr::summarise(Importe_Total_Diario = sum(Importe),
                                                       Frecuencia_Total_Diario = sum(Frecuencia)) %>% 
                                      dplyr::mutate(etiqueta = paste0("Días hasta Vigencia: ", format(DIAS_HASTA_FECHA_VIGENCIA, big.mark = ".", decimal.mark = ","), "<br>","Frecuencia Total: ", format(Frecuencia_Total_Diario, big.mark = ".", decimal.mark = ","), "<br>",
                                                       "Importe Total: $ ", format(Importe_Total_Diario, big.mark = ".", decimal.mark = ","), "<br>")) %>% 
                                      dplyr::filter(DIAS_HASTA_FECHA_VIGENCIA >= -100)

# definimos una función para generar una recta vertical
vline <- function(x = 0, color = "black") {
  list(
    type = "line",
    y0 = 0,
    y1 = 1,
    yref = "paper",
    x0 = x,
    x1 = x,
    line = list(color = color, dash="dot")
  )
}

# Gráfico de Serie de Tiempo
plot_ly(
  data = CONSUMOS_SOCIOS_DIST_VIGENCIA,
  x = ~DIAS_HASTA_FECHA_VIGENCIA,
  y = ~Frecuencia_Total_Diario,
  type = "scatter",
  mode = "lines+markers",
  hoverinfo = "text",
  text = ~etiqueta
) %>%
  layout(
    title = "Distribución de Consumo con respecto a FECHA VIGENCIA",
    xaxis = list(title = "Tiempo hasta Fecha Vigencia (en días)"),
    yaxis = list (title = "Frecuencia Total Diaria"),
    legend = list(
      x = 1,
      y = 0.5,
      yanchor = "middle"
    ),
    margin = list(l = 40, r = 160, b = 40, t = 40),
    height = 800,
    width = 1300,
    shapes = list(vline(90),
                  vline(-30))
  ) 

```

## Análisis de consumos

Consideraremos los consumos hasta 1 año después de la Fecha de Vigencia y partiendo desde 30 días debido a Alta diferidas. Luego a partir de los consumos pudimos obtener el siguiente cuadro de análisis, teniendo en cuenta que para la variable de operaciones filtramos por los siguientes DCOD_PRACTICAS:


- 20467: MODULO DE CIRUGIA REFRACTIVA(LASIK/LASEK): EXCIMER LASER EN MIOPIA Y ASTIGMATISMO-UNILAT

- 20169: MODULO DE COLOCACION DE LENTE INTRAOCULAR PARA ALTA MIOPIA (UNILATERAL).



```{r}
CONSUMOS_SOCIOS <- CONSUMOS_SOCIOS %>% 
                        dplyr::filter(as.numeric(ymd(DNUM_FECHA)-ymd(FECHA_VIGENCIA)) <= 365,
                                      as.numeric(ymd(DNUM_FECHA)-ymd(FECHA_VIGENCIA)) >= -30)

CONSUMOS_SOCIOS$EDAD_SOCIO <- round((ymd(CONSUMOS_SOCIOS$DNUM_FECHA) - ymd(CONSUMOS_SOCIOS$FEC_NACIMIENTO))/365.25,1)
CONSUMOS_SOCIOS$MAYOR_24 <- ifelse(test = CONSUMOS_SOCIOS$EDAD_SOCIO >= 24,
                                   yes = "Mayor de 24 años",
                                   no = "Menor de 24 años")


# Vamos a crear nuestro dataframe para analizar
# Crear dataframe base con las dos categorías
DIOP <- CONSUMOS_SOCIOS %>% 
            dplyr::distinct(PREGUNTA_14,MAYOR_24)


# Segunda variable vamos a habler el table de cantidad de personas
PERSONAS = CONSUMOS_SOCIOS %>% 
              dplyr::group_by(PREGUNTA_14,MAYOR_24) %>% 
              dplyr::summarise(Freq = n_distinct(DNUM_DOC))


# Vamos a hacer el left join
DIOP = DIOP %>% left_join(PERSONAS)
names(DIOP)[3] <- "Cantidad Personas"

# Filtramos los consumos con OFT en DDES_GRUPO_PRESUPUESTO
CONSUMOS_OFT <- CONSUMOS_SOCIOS %>% filter(str_detect(DDES_GRUPO_PRESUPUESTO, "OFT"))


# Tenemos con consumos en general
CONSUMOSGRAL = CONSUMOS_SOCIOS %>%
  group_by(PREGUNTA_14,MAYOR_24) %>%
  summarise(Socios_DistintosGRAL = n_distinct(DNUM_DOC)) %>%
  arrange(desc(Socios_DistintosGRAL))

# Cruzamos
DIOP = DIOP %>% left_join(CONSUMOSGRAL)
# names(DIOP)[3] <- "Personas con Consumo"


# Consumos en OFTALMOLOGIA
CONSUMOSOFT = CONSUMOS_OFT %>%
  group_by(PREGUNTA_14,MAYOR_24) %>%
  summarise(Socios_DistintosOFT = n_distinct(DNUM_DOC)) %>%
  arrange(desc(Socios_DistintosOFT))

# Cruzamos
DIOP = DIOP %>% left_join(CONSUMOSOFT)
# names(DIOP)[4] <- "Personas con Consumo en OFT"


# Identificamos con la operacion
CONSUMOSOP = CONSUMOS_SOCIOS %>%
  group_by(PREGUNTA_14,MAYOR_24) %>%
  filter(DCOD_PRACTICA %in% c(20467, 20169)) %>% 
  summarise(Socios_DistintosOP = n_distinct(DNUM_DOC)) %>%
  arrange(desc(Socios_DistintosOP))

# Cruzamos
DIOP = DIOP %>% left_join(CONSUMOSOP)
# names(DIOP)[5] <- "Personas con Operacion Refractiva"


# % Operado
DIOP$Porcentaje = DIOP$Socios_DistintosOP / DIOP$`Cantidad Personas`
DIOP[is.na(DIOP)] <- 0
DIOP$Porcentaje <- sprintf("%.2f%%", DIOP$Porcentaje * 100)
names(DIOP)[6] <- "% Operado Sobre total del Grupo"



# Ahora vamos a calcular el costo promedio entre los dos grupos en oftalmologia
CONSUMOS_OFT_RESUMEN <- CONSUMOS_OFT %>%
  mutate(
    MES = substr(as.character(DNUM_FECHA), 1, 6)  # Extrae el año y mes (YYYYMM)
  ) %>%
  group_by(DNUM_DOC, PREGUNTA_14,MAYOR_24) %>%
  summarise(
    CANT_MESES = n_distinct(MES),  # Cuenta los meses únicos de consumo
    SUMA_IMPORTE = sum(IMPORTE_TOTAL, na.rm = TRUE)
  ) %>%
  ungroup()

# Ahora sacamos el promedio MENSUAL de gasto por socio
CONSUMOS_OFT_RESUMEN$PROMEDIO_MENSUAL = CONSUMOS_OFT_RESUMEN$SUMA_IMPORTE / CONSUMOS_OFT_RESUMEN$CANT_MESES

# Sacamos el promedio por grupo
PROMEDIO_X_GRUPO <- CONSUMOS_OFT_RESUMEN %>%
  group_by(PREGUNTA_14,MAYOR_24) %>%
  summarise(
    PROMEDIO_GASTO_MENSUAL = mean(PROMEDIO_MENSUAL, na.rm = TRUE)
  )


# Cruzamos
DIOP = DIOP %>% left_join(PROMEDIO_X_GRUPO)
# names(DIOP)[7] <- "Promedio de Consumos Mensuales por Grupo"


# Y si traemos las contribuciones Marginales y hacemos lo mismo que con los consumos?
# Primero el kable de la tabla bien

# Formateamos la tabla 
DIOP$PROMEDIO_GASTO_MENSUAL <- paste0("$ ", format(round(DIOP$PROMEDIO_GASTO_MENSUAL), big.mark = ".", decimal.mark = ","))

DIOP[3:5] <- lapply(DIOP[3:5], function(x) format(x, big.mark = ".", decimal.mark = ","))


# Graficamos
DIOP %>%
  kbl(
    caption = "<b>Consumos y Operaciones Refractivas por Grupo de Dioptrías</b>",
    format = "html",
    align = c("l", rep("r", ncol(DIOP) - 1)),
    col.names = c(
      "Dioptrías",
      "Grupo Etario",
      "Cantidad Personas",
      "Personas con Consumo",
      "Personas con Consumo en OFT",
      "Personas con Operación",
      "% Operado sobre total del Grupo",
      "Promedio Consumos Mensuales en Oftalmología"
    )
  ) %>%
  kable_styling(
    full_width = TRUE,
    bootstrap_options = c("striped", "hover", "condensed"),
    position = "center"
  ) %>%
  row_spec(0, background = "#0072CE", color = "white")
# invisible(Sys.setlocale(category = "LC_TIME",locale = old_locale))
```











```{r}

# Bueno aca esperaría cuantos de esos se dieron de alta tipo tabla,
# Ademas otra variable si utilizaron la operacion que nosotros identificamos y ademas traer el promedio de la cmg
# Como te queda bien completa una tabla con:

# - Totalidad de socios unicos que pusieron miopia y califican como preexistencia
# - De ese total que % se dio de alta como socio (siempre teniendo en cuenta las fechas)
# - De eso que % consumio esa operacion en X meses mas o en total y despues si queres tomas en cuenta las fechas (aunque me parece indiferente)
# - Tambien promedio de CMG de ese grupo para entender si afecta (porque obviamente a esos le sube el devengado capaz da bien igual)
# - Explicitar que no se toma la suma de consumos porque algunos entraron hace un mes otros hace años no tiene sentido, ademas que no se pueden comparar con los que se operaron de miopía y no tuvieron preexistencia.
# Podemos sacarlo sumando los consumos y diviendo por la cantidad de meses.




```















